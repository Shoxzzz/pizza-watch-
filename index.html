<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>äº”è§’å¤§æ¥¼æƒ…æŠ¥å±€</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        :root { 
            --bg: #000000; 
            --card-bg: #121212; 
            --dash-bg: #1a1a1a;
            --text: #ffffff; 
            --sub-text: #666;
            --danger: #ff3b30;
            --warn: #ffcc00;
            --safe: #32d74b;
            --blue: #0a84ff;
        }

        html, body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Noto Sans SC', sans-serif;
            margin: 0; padding: 0;
            width: 100%;
            overflow-y: auto; 
            -webkit-overflow-scrolling: touch;
        }

        .header {
            padding: 16px 20px;
            background: rgba(10, 10, 10, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid #222;
            position: sticky; top: 0; z-index: 999;
            display: flex; justify-content: space-between; align-items: center;
        }
        .title { font-size: 16px; font-weight: 900; letter-spacing: 1px; color: #fff; }
        .live-badge {
            font-size: 11px; font-weight: bold; color: var(--safe);
            background: rgba(50, 215, 75, 0.1);
            padding: 4px 8px; border-radius: 4px;
            display: flex; align-items: center; gap: 6px;
        }
        .blink { width: 6px; height: 6px; background: currentColor; border-radius: 50%; animation: blink 2s infinite; }
        @keyframes blink { 0% {opacity:1} 50% {opacity:0.3} 100% {opacity:1} }

        .container { padding: 15px; display: flex; flex-direction: column; gap: 15px; padding-bottom: 80px; }

        /* ä»ªè¡¨ç›˜ */
        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 5px; }
        .dash-card {
            background: var(--dash-bg); border: 1px solid #333; border-radius: 12px;
            padding: 15px; display: flex; flex-direction: column; justify-content: center;
            position: relative; overflow: hidden;
        }
        .dash-glow {
            position: absolute; top: -50%; right: -50%; width: 100%; height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.05) 0%, transparent 60%); pointer-events: none;
        }
        .dash-lbl { font-size: 11px; color: #888; text-transform: uppercase; font-weight: bold; margin-bottom: 4px; }
        .dash-val { font-size: 26px; font-weight: 900; line-height: 1; }
        .dash-sub { font-size: 11px; margin-top: 4px; font-weight: 500; }

        /* æˆ˜æœ¯å¡ç‰‡åŸºç¡€æ ·å¼ */
        .card { background: var(--card-bg); border: 1px solid #2a2a2a; border-radius: 12px; padding: 16px; display: flex; flex-direction: column; gap: 12px; position: relative; }
        
        /* ğŸ”¥ V24 ç‰¹åŒºæŠ«è¨ä¸“å±æ ·å¼ï¼šçº¢è‰²å‘¼å¸è¾¹æ¡† */
        .card.core-target {
            border: 1px solid rgba(255, 59, 48, 0.3);
            box-shadow: 0 0 15px rgba(255, 59, 48, 0.1) inset;
            animation: pulse-border 3s infinite;
        }
        @keyframes pulse-border {
            0% { border-color: rgba(255, 59, 48, 0.3); }
            50% { border-color: rgba(255, 59, 48, 0.6); }
            100% { border-color: rgba(255, 59, 48, 0.3); }
        }

        /* æ ¸å¿ƒæ ‡è¯†æ ‡ç­¾ */
        .core-tag {
            position: absolute; top: 0; right: 0;
            background: var(--danger); color: #fff;
            font-size: 9px; font-weight: bold;
            padding: 2px 8px;
            border-bottom-left-radius: 8px;
            border-top-right-radius: 12px;
        }

        .row-top { display: flex; justify-content: space-between; align-items: flex-start; }
        .shop-name { font-size: 16px; font-weight: 700; color: #fff; margin-bottom: 2px; }
        .shop-desc { font-size: 11px; color: var(--sub-text); }
        .big-score { font-size: 28px; font-weight: 900; line-height: 1; letter-spacing: -1px; }

        .row-stats { display: flex; gap: 10px; padding: 10px; background: #080808; border-radius: 8px; border: 1px solid #222; }
        .stat-box { flex: 1; display: flex; flex-direction: column; gap: 2px; }
        .stat-lbl { font-size: 10px; color: #555; }
        .stat-val { font-size: 13px; font-weight: 700; }

        .spark-container { display: flex; align-items: flex-end; gap: 2px; height: 30px; margin-top: 5px; padding-top: 10px; border-top: 1px dashed #222; }
        .spark-bar { flex: 1; background: #333; border-radius: 2px; min-height: 2px; }

        .manual-card {
            background: #090909; border: 1px solid #333; border-radius: 12px; 
            padding: 20px; display: flex; flex-direction: column; gap: 15px;
        }
        .man-header { 
            font-size: 13px; font-weight: 900; color: #fff; text-transform: uppercase; 
            letter-spacing: 1px; border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 5px;
            display: flex; align-items: center; gap: 8px;
        }
        .man-icon { color: var(--warn); }
        .man-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .man-item { display: flex; flex-direction: column; gap: 8px; }
        .man-title { font-size: 11px; color: #888; font-weight: bold; }
        
        .demo-box { display: flex; align-items: center; gap: 8px; font-size: 11px; color: #ccc; }
        .demo-bar { width: 6px; height: 14px; background: #333; border-radius: 2px; }
        .demo-bar.red { background: var(--danger); box-shadow: 0 0 5px rgba(255, 59, 48, 0.4); }
        .demo-bar.gray { background: #333; }
        .demo-bar.white { background: #fff; }
        .demo-bar.tall { height: 18px; }
        .demo-bar.short { height: 6px; }
        
        .demo-arrow { font-weight: bold; font-size: 12px; }
        .c-red { color: var(--danger); }
        .c-green { color: var(--safe); }
        .c-gray { color: #888; }
        
        .loading { text-align: center; margin-top: 50px; color: #444; font-size: 12px; }
    </style>
</head>
<body>

    <div class="header">
        <div class="title">äº”è§’å¤§æ¥¼æƒ…æŠ¥å±€</div>
        <div class="live-badge"><div class="blink"></div>LIVE</div>
    </div>

    <div class="container">
        <div id="dash-area"></div>
        <div id="list-area">
            <div class="loading">æ­£åœ¨è§£å¯†å«æ˜Ÿæ•°æ®æµ...</div>
        </div>

        <div class="manual-card">
            <div class="man-header">
                <span class="man-icon">âš ï¸</span> æƒ…æŠ¥åˆ¤è¯»æ‰‹å†Œ (FIELD MANUAL)
            </div>

            <div class="man-grid">
                <div class="man-item">
                    <div class="man-title">é¢œè‰²å›¾é‰´ (COLOR)</div>
                    <div class="demo-box">
                        <div class="demo-bar red"></div> <span>çƒ­åº¦ > 50 (é«˜å¨èƒ)</span>
                    </div>
                    <div class="demo-box">
                        <div class="demo-bar gray"></div> <span>çƒ­åº¦ < 50 (å¸¸è§„)</span>
                    </div>
                </div>

                <div class="man-item">
                    <div class="man-title">å½¢æ€å«ä¹‰ (SHAPE)</div>
                    <div class="demo-box">
                        <div class="demo-bar tall"></div> <span>æŸ±å­é«˜ = äººå¤š</span>
                    </div>
                    <div class="demo-box">
                        <span class="demo-arrow c-red">â–²</span> <span>äººæ•°æ¿€å¢ (è­¦æŠ¥)</span>
                    </div>
                </div>
            </div>
            
            <div style="font-size:10px; color:#444; margin-top:5px; border-top:1px dashed #333; padding-top:10px;">
                <strong>â­ å…³äºæ ¸å¿ƒæŒ‡æ ‡ï¼š</strong><br>
                â€œç‰¹åŒºæŠ«è¨â€ (District Pizza) å› è·ç¦»æœ€è¿‘ä¸”è¥ä¸šè‡³æ·±å¤œï¼Œè¢«è§†ä¸ºåˆ¤æ–­äº”è§’å¤§æ¥¼å†…éƒ¨æ´»åŠ¨çš„æœ€æ•æ„Ÿé£å‘æ ‡ã€‚
            </div>
        </div>
        
        <div style="text-align:center; font-size:10px; color:#333; margin-top:5px;">PENTAGON OPS V24 // CORE INTEL</div>
    </div>

    <script>
        // ğŸ”¥ V24 æ”¹åŠ¨ï¼šæŠŠå¤‡æ³¨æ”¹æˆäº†é€šä¿—æ˜“æ‡‚çš„å¤§ç™½è¯
        const DICT = {
            "District": { name: "ç‰¹åŒºæŠ«è¨", desc: "æ ¸å¿ƒæŒ‡æ ‡ (äº”è§’å¤§æ¥¼é¦–é€‰)", isCore: true },
            "Domino":   { name: "è¾¾ç¾ä¹",   desc: "å¤–å–å·¨å¤´ (å¸¸è§„æ°‘ç”¨)",    isCore: false },
            "Papa":     { name: "æ£’çº¦ç¿°",   desc: "å¤–å–å·¨å¤´ (å¤‡ç”¨æ¸ é“)",    isCore: false },
            "Wiseguy":  { name: "Wiseguy",  desc: "åˆ‡ç‰‡æŠ«è¨ (æ•£å®¢ä¸ºä¸»)",    isCore: false },
            "We":       { name: "WeæŠ«è¨",   desc: "æ°´æ™¶åŸåˆ†éƒ¨ (å¤–å›´)",     isCore: false }
        };

        Papa.parse("pizza_data.csv", {
            download: true, header: true, skipEmptyLines: true,
            complete: function(res) {
                render(res.data);
            },
            error: function() {
                document.getElementById('list-area').innerHTML = '<div class="loading">æ•°æ®è¿æ¥å¤±è´¥</div>';
            }
        });

        function render(data) {
            if(!data || data.length === 0) return;

            const groups = {};
            data.forEach(row => {
                const rawName = row.Name || "";
                let key = null;
                if(rawName.includes("District")) key = "District";
                else if(rawName.includes("Domino")) key = "Domino";
                else if(rawName.includes("Papa")) key = "Papa";
                else if(rawName.includes("Wiseguy")) key = "Wiseguy";
                else if(rawName.includes("We")) key = "We";

                if(key) {
                    if(!groups[key]) groups[key] = [];
                    groups[key].push({
                        pop: parseInt(row['Live Popularity'] || 0),
                        time: row['Timestamp (ET)']
                    });
                }
            });

            let totalLivePop = 0; 
            let totalDiff = 0;    
            const shopDataList = [];
            
            Object.keys(groups).forEach(key => {
                const history = groups[key];
                if(history.length === 0) return;
                
                const current = history[history.length - 1];
                const currentPop = current.pop;

                let diff = 0;
                if(history.length >= 2) {
                    diff = currentPop - history[history.length - 2].pop;
                }

                totalLivePop += currentPop;
                totalDiff += diff;

                shopDataList.push({ key, history, currentPop, diff, current });
            });

            // æ’åºï¼šæ ¸å¿ƒæ®ç‚¹å¿…é¡»ç½®é¡¶ï¼ç„¶åæ‰æ˜¯æŒ‰çƒ­åº¦æ’åº
            shopDataList.sort((a, b) => {
                // å¦‚æœ a æ˜¯æ ¸å¿ƒï¼Œb ä¸æ˜¯ï¼Œa æ’å‰é¢
                if (DICT[a.key].isCore && !DICT[b.key].isCore) return -1;
                if (!DICT[a.key].isCore && DICT[b.key].isCore) return 1;
                // å¦åˆ™æŒ‰çƒ­åº¦é™åº
                return b.currentPop - a.currentPop;
            });

            const dashArea = document.getElementById('dash-area');
            let diffColor = "#888"; 
            let diffArrow = "-";
            if(totalDiff > 0) { diffColor = "var(--danger)"; diffArrow = "â–² +"; }
            else if(totalDiff < 0) { diffColor = "var(--safe)"; diffArrow = "â–¼ "; }
            let totalColor = totalLivePop > 150 ? "var(--danger)" : "#fff";

            dashArea.innerHTML = `
                <div class="dashboard-grid">
                    <div class="dash-card">
                        <div class="dash-glow"></div>
                        <div class="dash-lbl">å…¨ç½‘å®æ—¶æ€»çƒ­åº¦</div>
                        <div class="dash-val" style="color:${totalColor}">${totalLivePop}</div>
                        <div class="dash-sub" style="color:#666">5ä¸ªæ®ç‚¹æ±‡æ€»</div>
                    </div>
                    <div class="dash-card">
                        <div class="dash-glow"></div>
                        <div class="dash-lbl">1H æ€»å˜åŒ–é‡</div>
                        <div class="dash-val" style="color:${diffColor}">${diffArrow}${Math.abs(totalDiff)}</div>
                        <div class="dash-sub" style="color:${diffColor}">è¾ƒ1å°æ—¶å‰</div>
                    </div>
                </div>
            `;

            const listArea = document.getElementById('list-area');
            listArea.innerHTML = ""; 

            shopDataList.forEach(item => {
                const { key, history, currentPop, diff, current } = item;
                const conf = DICT[key];

                let diffHtml = `<span class="c-gray">--</span>`;
                if(diff > 0) diffHtml = `<span class="c-red">â–² +${diff}</span>`;
                else if(diff < 0) diffHtml = `<span class="c-green">â–¼ ${diff}</span>`;

                const last24 = history.slice(-24);
                const maxPop = Math.max(...last24.map(i => i.pop));

                const sparkData = history.slice(-20); 
                let barsHtml = "";
                sparkData.forEach((d, idx) => {
                    const isLast = idx === sparkData.length - 1;
                    const h = Math.max(5, d.pop);
                    const color = isLast ? '#fff' : (d.pop > 50 ? '#ff3b30' : '#333');
                    const opacity = isLast ? 1 : 0.6;
                    barsHtml += `<div class="spark-bar" style="height:${h}%; background:${color}; opacity:${opacity}"></div>`;
                });

                // ğŸ”¥ V24: æ ¸å¿ƒæ®ç‚¹æ·»åŠ ç‰¹æ®Š CSS ç±»å’Œæ ‡ç­¾
                const coreClass = conf.isCore ? 'core-target' : '';
                const coreTag = conf.isCore ? '<div class="core-tag">â­ KEY INTEL</div>' : '';

                listArea.innerHTML += `
                <div class="card ${coreClass}">
                    ${coreTag}
                    <div class="row-top">
                        <div>
                            <div class="shop-name" style="${conf.isCore ? 'color:var(--danger)' : ''}">${conf.name}</div>
                            <div class="shop-desc">${conf.desc}</div>
                        </div>
                        <div class="big-score" style="color: ${currentPop > 50 ? '#ff3b30' : '#fff'}">${currentPop}</div>
                    </div>
                    <div class="row-stats">
                        <div class="stat-box">
                            <div class="stat-lbl">1H å˜åŒ–</div>
                            <div class="stat-val">${diffHtml}</div>
                        </div>
                        <div class="stat-box" style="border-left:1px solid #222; padding-left:10px;">
                            <div class="stat-lbl">24H å³°å€¼</div>
                            <div class="stat-val" style="color:#fff">${maxPop}</div>
                        </div>
                        <div class="stat-box" style="border-left:1px solid #222; padding-left:10px;">
                            <div class="stat-lbl">æ›´æ–°äº</div>
                            <div class="stat-val" style="color:#888">${current.time.split(" ")[1].substring(0,5)}</div>
                        </div>
                    </div>
                    <div class="spark-container">${barsHtml}</div>
                </div>
                `;
            });
        }
    </script>
</body>
</html>
