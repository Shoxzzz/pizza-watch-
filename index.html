<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PENTAGON INTEL V5</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@1.0.1/dist/chartjs-adapter-moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        :root { --bg: #000000; --card: #0a0a0a; --text: #e0e0e0; --accent: #00ff41; --danger: #ff0055; }
        body {
            background-color: var(--bg); color: var(--text);
            font-family: 'Courier New', Courier, monospace; /* 黑客风格字体 */
            margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column;
            overflow: hidden;
        }
        
        /* 顶部 KPI 战术面板 */
        .dashboard-header {
            padding: 10px 15px; background: #050505; border-bottom: 1px solid #333;
            display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;
        }
        .kpi-card {
            background: var(--card); border: 1px solid #333; padding: 10px; border-radius: 4px;
            display: flex; flex-direction: column; justify-content: center;
        }
        .kpi-label { font-size: 10px; color: #666; text-transform: uppercase; margin-bottom: 4px; }
        .kpi-value { font-size: 16px; font-weight: bold; color: var(--accent); }
        .kpi-value.danger { color: var(--danger); text-shadow: 0 0 5px var(--danger); }
        
        /* 标题栏 */
        .status-bar {
            padding: 5px 15px; font-size: 10px; color: #444; display: flex; justify-content: space-between;
            background: #020202;
        }
        
        /* 图表区 */
        .chart-container { flex: 1; position: relative; padding: 10px; }
        
        /* 底部控制栏 */
        .controls {
            padding: 10px; display: flex; justify-content: center; gap: 10px; background: #050505;
        }
        .btn {
            background: transparent; border: 1px solid #444; color: #888; padding: 5px 15px;
            font-family: inherit; font-size: 10px; cursor: pointer;
        }
        .btn.active { background: var(--accent); color: #000; border-color: var(--accent); }
        
        /* 动画点 */
        .live-dot { width: 8px; height: 8px; background: var(--danger); border-radius: 50%; box-shadow: 0 0 10px var(--danger); animation: blink 1s infinite; display: inline-block; margin-right: 5px; }
        @keyframes blink { 50% { opacity: 0; } }
    </style>
</head>
<body>
    <div class="status-bar">
        <span>SYSTEM: ONLINE // ENCRYPTED</span>
        <span>LOC: ARLINGTON, VA</span>
    </div>

    <div class="dashboard-header">
        <div class="kpi-card">
            <span class="kpi-label">Max Intensity</span>
            <span class="kpi-value" id="max-pop">--</span>
        </div>
        <div class="kpi-card">
            <span class="kpi-label">Active Threat</span>
            <span class="kpi-value" id="threat-level">LOW</span>
        </div>
        <div class="kpi-card">
            <span class="kpi-label">Status</span>
            <span class="kpi-value" style="color: #00ff41;">LIVE</span>
        </div>
    </div>

    <div class="chart-container">
        <canvas id="mainChart"></canvas>
    </div>

    <div class="controls">
        <button class="btn active" onclick="updateTime(24)">24H</button>
        <button class="btn" onclick="updateTime(168)">7 DAYS</button>
    </div>

    <script>
        let chart, rawData = [];
        const colors = { "District Pizza Palace": "#ff0055", "Domino's Pizza": "#00ccff", "Papa John's Pizza": "#cc00ff", "Wiseguy Pizza": "#ffff00", "We": "#00ff41", "We, The Pizza": "#00ff41" };

        Papa.parse("pizza_data.csv", {
            download: true, header: true, skipEmptyLines: true,
            complete: res => {
                rawData = res.data;
                initChart();
                updateTime(24);
                updateKPI(); // 计算 KPI
            }
        });

        function updateKPI() {
            // 计算最近24小时的最大热度
            if(!rawData.length) return;
            const now = moment();
            const recent = rawData.filter(r => moment(r['Timestamp (ET)']).isAfter(now.clone().subtract(24, 'hours')));
            
            let maxVal = 0;
            recent.forEach(r => {
                const val = parseInt(r['Live Popularity']||0);
                if(val > maxVal) maxVal = val;
            });
            
            const maxEl = document.getElementById('max-pop');
            maxEl.innerText = maxVal;
            if(maxVal > 50) {
                maxEl.classList.add('danger');
                document.getElementById('threat-level').innerText = "HIGH";
                document.getElementById('threat-level').style.color = "#ff0055";
            }
        }

        function updateTime(hours) {
            document.querySelectorAll('.btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            
            const cutoff = moment().subtract(hours, 'hours');
            const datasets = {};
            
            rawData.forEach(r => {
                const t = moment(r['Timestamp (ET)']);
                if(t.isBefore(cutoff)) return;
                const n = r.Name;
                if(!datasets[n]) datasets[n] = [];
                datasets[n].push({x: t.valueOf(), y: r['Live Popularity']});
            });

            chart.data.datasets = Object.keys(datasets).map(n => ({
                label: n, data: datasets[n],
                borderColor: colors[n]||'#fff', borderWidth: 1, pointRadius: 0,
                tension: 0.2
            }));
            
            chart.options.scales.x.time.unit = hours > 24 ? 'day' : 'hour';
            chart.update();
        }

        function initChart() {
            chart = new Chart(document.getElementById('mainChart'), {
                type: 'line',
                data: { datasets: [] },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: { legend: { position: 'bottom', labels: { color: '#666', boxWidth: 8, font: {family: 'Courier New'} } } },
                    scales: {
                        x: { type: 'time', grid: { color: '#111' }, ticks: { color: '#666' } },
                        y: { grid: { color: '#111' }, ticks: { color: '#666' }, beginAtZero: true, suggestedMax: 100 }
                    }
                }
            });
        }
    </script>
</body>
</html>
