<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>äº”è§’å¤§æ¥¼æƒ…æŠ¥å±€</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        :root { 
            --bg: #000000; 
            --card-bg: #121212; 
            --dash-bg: #1a1a1a;
            --text: #ffffff; 
            --sub-text: #666;
            --danger: #ff3b30;
            --warn: #ffcc00;
            --safe: #32d74b;
            --blue: #0a84ff;
        }

        html, body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Noto Sans SC', sans-serif;
            margin: 0; padding: 0;
            width: 100%;
            overflow-y: auto; 
            -webkit-overflow-scrolling: touch;
        }

        /* é¡¶éƒ¨å¯¼èˆª */
        .header {
            padding: 16px 20px;
            background: rgba(10, 10, 10, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid #222;
            position: sticky; top: 0; z-index: 999;
            display: flex; justify-content: space-between; align-items: center;
        }
        .title { font-size: 16px; font-weight: 900; letter-spacing: 1px; color: #fff; }
        .live-badge {
            font-size: 11px; font-weight: bold; color: var(--safe);
            background: rgba(50, 215, 75, 0.1);
            padding: 4px 8px; border-radius: 4px;
            display: flex; align-items: center; gap: 6px;
        }
        .blink { width: 6px; height: 6px; background: currentColor; border-radius: 50%; animation: blink 2s infinite; }
        @keyframes blink { 0% {opacity:1} 50% {opacity:0.3} 100% {opacity:1} }

        .container { padding: 15px; display: flex; flex-direction: column; gap: 15px; padding-bottom: 80px; }

        /* ğŸ”¥ æ–°å¢ï¼šæ€»æŒ‡æŒ¥ä»ªè¡¨ç›˜ */
        .dashboard-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
            margin-bottom: 5px;
        }
        .dash-card {
            background: var(--dash-bg);
            border: 1px solid #333;
            border-radius: 12px;
            padding: 15px;
            display: flex; flex-direction: column; justify-content: center;
            position: relative; overflow: hidden;
        }
        /* ä»ªè¡¨ç›˜èƒŒæ™¯å…‰æ•ˆ */
        .dash-glow {
            position: absolute; top: -50%; right: -50%; width: 100%; height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.05) 0%, transparent 60%);
            pointer-events: none;
        }
        .dash-lbl { font-size: 11px; color: #888; text-transform: uppercase; font-weight: bold; margin-bottom: 4px; }
        .dash-val { font-size: 26px; font-weight: 900; line-height: 1; }
        .dash-sub { font-size: 11px; margin-top: 4px; font-weight: 500; }

        /* åˆ†åº—æˆ˜æœ¯å¡ç‰‡ */
        .card {
            background: var(--card-bg);
            border: 1px solid #2a2a2a;
            border-radius: 12px;
            padding: 16px;
            display: flex; flex-direction: column; gap: 12px;
        }

        .row-top { display: flex; justify-content: space-between; align-items: flex-start; }
        .shop-name { font-size: 16px; font-weight: 700; color: #fff; margin-bottom: 2px; }
        .shop-desc { font-size: 11px; color: var(--sub-text); }
        .big-score { font-size: 28px; font-weight: 900; line-height: 1; letter-spacing: -1px; }

        .row-stats { 
            display: flex; gap: 10px; 
            padding: 10px; background: #080808; border-radius: 8px; 
            border: 1px solid #222;
        }
        .stat-box { flex: 1; display: flex; flex-direction: column; gap: 2px; }
        .stat-lbl { font-size: 10px; color: #555; }
        .stat-val { font-size: 13px; font-weight: 700; }

        .spark-container {
            display: flex; align-items: flex-end; gap: 2px;
            height: 30px; 
            margin-top: 5px;
            padding-top: 10px;
            border-top: 1px dashed #222;
        }
        .spark-bar { flex: 1; background: #333; border-radius: 2px; min-height: 2px; }

        .c-red { color: var(--danger); }
        .c-green { color: var(--safe); }
        .c-gray { color: #888; }
        
        .loading { text-align: center; margin-top: 50px; color: #444; font-size: 12px; }
    </style>
</head>
<body>

    <div class="header">
        <div class="title">äº”è§’å¤§æ¥¼æƒ…æŠ¥å±€</div>
        <div class="live-badge"><div class="blink"></div>LIVE</div>
    </div>

    <div class="container">
        <div id="dash-area"></div>
        
        <div id="list-area">
            <div class="loading">æ­£åœ¨æ±‡æ€»å„åˆ†éƒ¨æ•°æ®...</div>
        </div>
    </div>

    <script>
        const DICT = {
            "District": { name: "ç‰¹åŒºæŠ«è¨", desc: "æ ¸å¿ƒæ®ç‚¹" },
            "Domino":   { name: "è¾¾ç¾ä¹",   desc: "å¤–å–å·¨å¤´" },
            "Papa":     { name: "æ£’çº¦ç¿°",   desc: "å¤–å–å¤‡é€‰" },
            "Wiseguy":  { name: "Wiseguy",  desc: "åˆ‡ç‰‡æ•£å®¢" },
            "We":       { name: "WeæŠ«è¨",   desc: "æ°´æ™¶åŸ" }
        };

        Papa.parse("pizza_data.csv", {
            download: true, header: true, skipEmptyLines: true,
            complete: function(res) {
                render(res.data);
            },
            error: function() {
                document.getElementById('list-area').innerHTML = '<div class="loading">æ•°æ®è¿æ¥å¤±è´¥</div>';
            }
        });

        function render(data) {
            if(!data || data.length === 0) return;

            const groups = {};
            data.forEach(row => {
                const rawName = row.Name || "";
                let key = null;
                if(rawName.includes("District")) key = "District";
                else if(rawName.includes("Domino")) key = "Domino";
                else if(rawName.includes("Papa")) key = "Papa";
                else if(rawName.includes("Wiseguy")) key = "Wiseguy";
                else if(rawName.includes("We")) key = "We";

                if(key) {
                    if(!groups[key]) groups[key] = [];
                    groups[key].push({
                        pop: parseInt(row['Live Popularity'] || 0),
                        time: row['Timestamp (ET)']
                    });
                }
            });

            // --- ğŸ§® 1. å…¨å±€æ•°æ®è®¡ç®— ---
            let totalLivePop = 0; // å½“å‰å…¨ç½‘æ€»äººæ•°
            let totalDiff = 0;    // å½“å‰å…¨ç½‘ 1å°æ—¶ å˜åŒ–é‡
            let sortedKeys = [];

            // å…ˆé¢„å¤„ç†æ‰€æœ‰åº—ï¼Œç®—å‡ºæ€»æ•°ï¼Œé¡ºä¾¿å‡†å¤‡æ’åº
            const shopDataList = [];
            Object.keys(groups).forEach(key => {
                const history = groups[key];
                if(history.length === 0) return;
                
                const current = history[history.length - 1];
                const currentPop = current.pop;

                // è®¡ç®—å•åº—å˜åŒ–
                let diff = 0;
                if(history.length >= 2) {
                    diff = currentPop - history[history.length - 2].pop;
                }

                // ç´¯åŠ åˆ°æ€»æ•°
                totalLivePop += currentPop;
                totalDiff += diff;

                shopDataList.push({ key, history, currentPop, diff, current });
            });

            // æŒ‰çƒ­åº¦é™åºæ’åº
            shopDataList.sort((a, b) => b.currentPop - a.currentPop);

            // --- ğŸ¨ 2. æ¸²æŸ“é¡¶éƒ¨æ€»ä»ªè¡¨ç›˜ (Dashboard) ---
            const dashArea = document.getElementById('dash-area');
            
            // æ€»å˜åŒ–çš„é¢œè‰²é€»è¾‘
            let diffColor = "#888"; 
            let diffArrow = "-";
            if(totalDiff > 0) { diffColor = "var(--danger)"; diffArrow = "â–² +"; }
            else if(totalDiff < 0) { diffColor = "var(--safe)"; diffArrow = "â–¼ "; }

            // æ€»çƒ­åº¦å¦‚æœå¤ªé«˜ï¼Œæ˜¾ç¤ºçº¢è‰²
            let totalColor = totalLivePop > 150 ? "var(--danger)" : "#fff";

            dashArea.innerHTML = `
                <div class="dashboard-grid">
                    <div class="dash-card">
                        <div class="dash-glow"></div>
                        <div class="dash-lbl">å…¨ç½‘å®æ—¶æ€»çƒ­åº¦</div>
                        <div class="dash-val" style="color:${totalColor}">${totalLivePop}</div>
                        <div class="dash-sub" style="color:#666">5ä¸ªæ®ç‚¹æ±‡æ€»</div>
                    </div>
                    <div class="dash-card">
                        <div class="dash-glow"></div>
                        <div class="dash-lbl">1H æ€»å˜åŒ–é‡</div>
                        <div class="dash-val" style="color:${diffColor}">${diffArrow}${Math.abs(totalDiff)}</div>
                        <div class="dash-sub" style="color:${diffColor}">è¾ƒ1å°æ—¶å‰</div>
                    </div>
                </div>
            `;

            // --- ğŸ¨ 3. æ¸²æŸ“åˆ†åº—åˆ—è¡¨ ---
            const listArea = document.getElementById('list-area');
            listArea.innerHTML = ""; 

            shopDataList.forEach(item => {
                const { key, history, currentPop, diff, current } = item;
                const conf = DICT[key];

                // å•åº—å˜åŒ–æ˜¾ç¤º
                let diffHtml = `<span class="c-gray">--</span>`;
                if(diff > 0) diffHtml = `<span class="c-red">â–² +${diff}</span>`;
                else if(diff < 0) diffHtml = `<span class="c-green">â–¼ ${diff}</span>`;

                // 24H å³°å€¼
                const last24 = history.slice(-24);
                const maxPop = Math.max(...last24.map(i => i.pop));

                // è¿·ä½ æŸ±çŠ¶å›¾
                const sparkData = history.slice(-20); 
                let barsHtml = "";
                sparkData.forEach((d, idx) => {
                    const isLast = idx === sparkData.length - 1;
                    const h = Math.max(5, d.pop);
                    const color = isLast ? '#fff' : (d.pop > 50 ? '#ff3b30' : '#333');
                    const opacity = isLast ? 1 : 0.6;
                    barsHtml += `<div class="spark-bar" style="height:${h}%; background:${color}; opacity:${opacity}"></div>`;
                });

                listArea.innerHTML += `
                <div class="card">
                    <div class="row-top">
                        <div>
                            <div class="shop-name">${conf.name}</div>
                            <div class="shop-desc">${conf.desc}</div>
                        </div>
                        <div class="big-score" style="color: ${currentPop > 50 ? '#ff3b30' : '#fff'}">${currentPop}</div>
                    </div>
                    <div class="row-stats">
                        <div class="stat-box">
                            <div class="stat-lbl">1H å˜åŒ–</div>
                            <div class="stat-val">${diffHtml}</div>
                        </div>
                        <div class="stat-box" style="border-left:1px solid #222; padding-left:10px;">
                            <div class="stat-lbl">24H å³°å€¼</div>
                            <div class="stat-val" style="color:#fff">${maxPop}</div>
                        </div>
                        <div class="stat-box" style="border-left:1px solid #222; padding-left:10px;">
                            <div class="stat-lbl">æ›´æ–°äº</div>
                            <div class="stat-val" style="color:#888">${current.time.split(" ")[1].substring(0,5)}</div>
                        </div>
                    </div>
                    <div class="spark-container">${barsHtml}</div>
                </div>
                `;
            });
            
            listArea.innerHTML += `<div style="text-align:center; font-size:10px; color:#333; margin-top:10px;">PENTAGON OPS V20 // GLOBAL VIEW</div>`;
        }
    </script>
</body>
</html>
