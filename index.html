<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>äº”è§’å¤§æ¥¼æƒ…æŠ¥å±€</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        :root { 
            --bg: #000000; 
            --card-bg: #141414; 
            --text: #ffffff; 
            --sub-text: #888888;
            --danger: #ff3b30; /* çº¢ */
            --warn: #ffcc00;   /* é»„ */
            --safe: #34c759;   /* ç»¿ */
            --blue: #007aff;   /* è“ */
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Noto Sans SC', -apple-system, BlinkMacSystemFont, sans-serif;
            margin: 0; padding: 0;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            min-height: 100vh;
            display: flex; flex-direction: column;
        }

        /* 1. é¡¶éƒ¨å¯¼èˆª */
        .header {
            padding: 16px 20px;
            background: rgba(20, 20, 20, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid #222;
            position: sticky; top: 0; z-index: 99;
            display: flex; justify-content: space-between; align-items: center;
        }
        .title { font-size: 18px; font-weight: 900; letter-spacing: 1px; }
        .status-badge {
            font-size: 12px; font-weight: bold; color: var(--safe);
            background: rgba(52, 199, 89, 0.15);
            padding: 4px 10px; border-radius: 100px;
            display: flex; align-items: center; gap: 6px;
        }
        .blink { width: 6px; height: 6px; background: currentColor; border-radius: 50%; animation: blink 1.5s infinite; }
        @keyframes blink { 0% {opacity:1} 50% {opacity:0.3} 100% {opacity:1} }

        /* 2. åˆ—è¡¨å®¹å™¨ */
        .container { padding: 20px; display: flex; flex-direction: column; gap: 16px; }

        /* 3. æˆ˜æœ¯å¡ç‰‡ */
        .card {
            background: var(--card-bg);
            border: 1px solid #333;
            border-radius: 16px;
            padding: 20px;
            display: flex; flex-direction: column; gap: 12px;
            position: relative;
            overflow: hidden;
        }

        /* å¡ç‰‡å¤´éƒ¨ï¼šåå­—å’Œçƒ­åº¦ */
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; }
        .shop-name { font-size: 18px; font-weight: 700; margin-bottom: 4px; }
        .shop-desc { font-size: 12px; color: var(--sub-text); }
        
        /* å¤§æ•°å­—çƒ­åº¦ */
        .pop-score { font-size: 32px; font-weight: 900; line-height: 1; }
        .pop-label { font-size: 10px; color: var(--sub-text); text-align: right; margin-top: 4px; }

        /* è¿›åº¦æ¡ */
        .progress-bg { width: 100%; height: 6px; background: #333; border-radius: 3px; overflow: hidden; }
        .progress-bar { height: 100%; border-radius: 3px; transition: width 0.5s ease; }

        /* åº•éƒ¨ä¿¡æ¯ï¼šçŠ¶æ€å’Œæ—¶é—´ */
        .card-footer { display: flex; justify-content: space-between; align-items: center; font-size: 12px; color: var(--sub-text); padding-top: 4px; }
        .trend-tag { font-weight: bold; padding: 2px 6px; border-radius: 4px; }

        /* çŠ¶æ€é…è‰² */
        .bg-red { background-color: var(--danger); }
        .bg-blue { background-color: var(--blue); }
        .bg-green { background-color: var(--safe); }
        .bg-yellow { background-color: var(--warn); }
        
        .text-red { color: var(--danger); }
        .text-blue { color: var(--blue); }
        .text-green { color: var(--safe); }
        .text-yellow { color: var(--warn); }

        /* åŠ è½½ä¸­ */
        .loading { text-align: center; margin-top: 50px; color: #666; font-size: 14px; }
    </style>
</head>
<body>

    <div class="header">
        <div class="title">äº”è§’å¤§æ¥¼æƒ…æŠ¥å±€</div>
        <div class="status-badge"><div class="blink"></div>å®æ—¶ç›‘æ§</div>
    </div>

    <div class="container" id="list-area">
        <div class="loading">æ­£åœ¨è¿æ¥å«æ˜Ÿæ•°æ®...<br>è§£æä¸­æ–‡æ•°æ®åŒ…...</div>
    </div>

    <script>
        // ğŸ’¢ æš´åŠ›æ±‰åŒ–å­—å…¸ï¼šä¸ç®¡ CSV åªæœ‰ä»€ä¹ˆè‹±æ–‡ï¼Œåªè¦åŒ¹é…åˆ°å…³é”®è¯ï¼Œå°±æ˜¾ç¤ºè¿™ä¸ªä¸­æ–‡
        const DICT = {
            "District": { name: "ç‰¹åŒºæŠ«è¨", desc: "æ ¸å¿ƒæ®ç‚¹ (äº”è§’å¤§æ¥¼é¦–é€‰)", color: "bg-red" },
            "Domino":   { name: "è¾¾ç¾ä¹",   desc: "å¤–å–å·¨å¤´ (å¸¸è§„)",        color: "bg-blue" },
            "Papa":     { name: "æ£’çº¦ç¿°",   desc: "å¤–å–å·¨å¤´ (å¤‡é€‰)",        color: "bg-blue" }, // æ£’çº¦ç¿°ä¹Ÿç®—è“è‰²é˜µè¥
            "Wiseguy":  { name: "Wiseguy",  desc: "åˆ‡ç‰‡æŠ«è¨åº— (æ•£å®¢)",      color: "bg-yellow" },
            "We":       { name: "WeæŠ«è¨",   desc: "æ°´æ™¶åŸåˆ†éƒ¨",            color: "bg-green" }
        };

        Papa.parse("pizza_data.csv", {
            download: true, header: true, skipEmptyLines: true,
            complete: function(res) {
                renderList(res.data);
            },
            error: function() {
                document.getElementById('list-area').innerHTML = '<div class="loading">è¯»å–å¤±è´¥ï¼Œè¯·æ£€æŸ¥ pizza_data.csv</div>';
            }
        });

        function renderList(data) {
            if(!data || data.length === 0) return;

            // 1. æ‰¾åˆ°æ¯å®¶åº—çš„ã€æœ€æ–°ã€‘ä¸€æ¡æ•°æ®
            const latest = {};
            // å€’åºéå†ï¼Œå–æœ€åå‡ºç°çš„æ•°æ®
            for(let i = data.length - 1; i >= 0; i--) {
                const row = data[i];
                const rawName = row.Name || "";
                
                // ğŸ•µï¸â€â™‚ï¸ æ¨¡ç³ŠåŒ¹é… Key (åŒ…å«å³å‘½ä¸­)
                let key = null;
                if(rawName.includes("District")) key = "District";
                else if(rawName.includes("Domino")) key = "Domino";
                else if(rawName.includes("Papa")) key = "Papa";
                else if(rawName.includes("Wiseguy")) key = "Wiseguy";
                else if(rawName.includes("We")) key = "We";

                // å¦‚æœæ‰¾åˆ°äº† Key ä¸”è¿˜æ²¡å­˜è¿‡ï¼Œå°±å­˜ä¸‹æ¥
                if(key && !latest[key]) {
                    latest[key] = {
                        pop: parseInt(row['Live Popularity'] || 0),
                        gap: parseInt(row['Gap'] || 0), // å¼‚å¸¸åå·®
                        time: row['Timestamp (ET)']
                    };
                }
                // æ‰¾é½5å®¶åº—å°±åœæ­¢ï¼Œä¸ç”¨éå†å‡ ä¸‡è¡Œ
                if(Object.keys(latest).length === 5) break;
            }

            // 2. è½¬æ¢æˆæ•°ç»„å¹¶ã€æŒ‰çƒ­åº¦æ’åºã€‘(æœ€å¿™çš„æ’ä¸Šé¢)
            const list = Object.keys(latest).map(k => ({ key: k, ...latest[k] }))
                                          .sort((a, b) => b.pop - a.pop);

            // 3. ç”Ÿæˆ HTML
            const area = document.getElementById('list-area');
            area.innerHTML = ""; // æ¸…ç©º

            list.forEach(item => {
                const conf = DICT[item.key];
                const pop = item.pop;
                const gap = item.gap;
                
                // å¤„ç†æ—¶é—´ (åªæ˜¾ç¤º HH:mm)
                let timeStr = item.time;
                if(timeStr.includes(" ")) timeStr = timeStr.split(" ")[1].substring(0, 5);

                // å¤„ç†å¼‚å¸¸çŠ¶æ€æ–‡æ¡ˆ
                let statusHtml = `<span style="color:#666">å¹³ç¨³ (æ­£å¸¸)</span>`;
                if (gap >= 20) statusHtml = `<span class="text-red">ğŸ”¥ æ¿€å¢ (+${gap})</span>`;
                else if (gap > 5) statusHtml = `<span class="text-yellow">ğŸ“ˆ ä¸Šå‡ (+${gap})</span>`;
                else if (gap < -5) statusHtml = `<span class="text-green">ğŸ“‰ ä¸‹é™ (${gap})</span>`;

                // åªæœ‰çƒ­åº¦è¶…è¿‡50æ‰å˜çº¢ï¼Œå¦åˆ™ç™½è‰²
                const scoreColor = pop > 50 ? 'text-red' : 'text-white';

                const html = `
                <div class="card">
                    <div class="card-header">
                        <div>
                            <div class="shop-name">${conf.name}</div>
                            <div class="shop-desc">${conf.desc}</div>
                        </div>
                        <div>
                            <div class="pop-score ${scoreColor}">${pop}</div>
                            <div class="pop-label">å½“å‰çƒ­åº¦</div>
                        </div>
                    </div>

                    <div class="progress-bg">
                        <div class="progress-bar ${conf.color}" style="width: ${pop}%"></div>
                    </div>

                    <div class="card-footer">
                        <div>${statusHtml}</div>
                        <div>æ›´æ–°äº ${timeStr}</div>
                    </div>
                </div>
                `;
                area.innerHTML += html;
            });
            
            // åº•éƒ¨åŠ ä¸ªæ°´å°
            area.innerHTML += `<div style="text-align:center; font-size:10px; color:#333; margin-top:20px;">
                ä»…ä¾›å†…éƒ¨å‚è€ƒ // PENTAGON OPS V17
            </div>`;
        }
    </script>
</body>
</html>
