<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>PENTAGON V9</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        :root {
            --bg: #000000;
            --card: #121212;
            --text-main: #ffffff;
            --text-sub: #888888;
            --accent: #2997ff; /* iOS Blue */
            --danger: #ff453a; /* iOS Red */
            --success: #30d158; /* iOS Green */
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: var(--bg);
            color: var(--text-main);
            font-family: 'Inter', -apple-system, sans-serif;
            margin: 0; padding: 0;
            height: 100vh;
            display: flex; flex-direction: column;
            overflow: hidden;
            padding-top: env(safe-area-inset-top); /* é¿å¼€åˆ˜æµ· */
            padding-bottom: env(safe-area-inset-bottom); /* é¿å¼€åº•éƒ¨æ¨ªæ¡ */
        }

        /* 1. é¡¶éƒ¨æ ‡é¢˜ */
        .header {
            padding: 12px 20px;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #222;
        }
        .brand { font-size: 16px; font-weight: 700; letter-spacing: -0.5px; }
        .live-badge {
            font-size: 11px; color: var(--success); font-weight: 600;
            background: rgba(48, 209, 88, 0.1); padding: 4px 10px; border-radius: 100px;
            display: flex; align-items: center; gap: 6px;
        }
        .dot { width: 6px; height: 6px; background: currentColor; border-radius: 50%; animation: pulse 2s infinite; }
        @keyframes pulse { 50% { opacity: 0.3; } }

        /* 2. ä¿®å¤ç‚¹ï¼šKPI æ»‘åŠ¨è½¨é“ (åƒ App Store é‚£æ ·) */
        .kpi-scroll-view {
            display: flex;
            gap: 12px;
            padding: 16px 20px;
            overflow-x: auto; /* å…è®¸æ¨ªå‘æ»‘åŠ¨ */
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch; /* iOS ä¸æ»‘æ»šåŠ¨ */
            flex-shrink: 0; /* é˜²æ­¢è¢«æŒ¤å‹ */
        }
        /* éšè—æ»šåŠ¨æ¡ */
        .kpi-scroll-view::-webkit-scrollbar { display: none; }
        
        .kpi-card {
            background: var(--card);
            border: 1px solid #222;
            border-radius: 12px;
            padding: 12px 16px;
            min-width: 110px; /* å›ºå®šæœ€å°å®½åº¦ï¼Œç¡®ä¿ä¸æ¢è¡Œ */
            display: flex; flex-direction: column; justify-content: center;
        }
        .kpi-label { font-size: 10px; color: var(--text-sub); text-transform: uppercase; margin-bottom: 4px; font-weight: 600; }
        .kpi-val { font-size: 20px; font-weight: 700; letter-spacing: -0.5px; }

        /* 3. å›¾è¡¨åŒº (è‡ªé€‚åº”å¡«å……) */
        .chart-wrapper {
            flex: 1; /* å æ»¡å‰©ä½™ç©ºé—´ */
            position: relative;
            margin: 0 10px;
            background: rgba(255,255,255,0.03);
            border-radius: 16px;
        }

        /* 4. åº•éƒ¨å›¾ä¾‹ (ä¹Ÿæ˜¯æ»‘åŠ¨çš„) */
        .legend-bar {
            padding: 16px 20px;
            display: flex; gap: 10px;
            overflow-x: auto;
            border-top: 1px solid #222;
            flex-shrink: 0;
        }
        .legend-bar::-webkit-scrollbar { display: none; }

        .pill {
            background: #1a1a1a;
            padding: 6px 12px; border-radius: 8px;
            font-size: 11px; font-weight: 500; color: #ccc;
            white-space: nowrap;
            display: flex; align-items: center; gap: 6px;
            border: 1px solid #333;
        }
        .color-block { width: 3px; height: 12px; border-radius: 2px; }

    </style>
</head>
<body>

    <div class="header">
        <div class="brand">PENTAGON V9</div>
        <div class="live-badge"><div class="dot"></div>LIVE</div>
    </div>

    <div class="kpi-scroll-view">
        <div class="kpi-card">
            <div class="kpi-label">Max Peak</div>
            <div class="kpi-val" id="val-max">--</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Threat Level</div>
            <div class="kpi-val" id="val-level" style="color:var(--success)">LOW</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Active Spots</div>
            <div class="kpi-val">5</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Status</div>
            <div class="kpi-val" style="color:var(--accent)">SYNCED</div>
        </div>
    </div>

    <div class="chart-wrapper">
        <canvas id="mainChart"></canvas>
    </div>

    <div class="legend-bar" id="legend-container"></div>

    <script>
        // ğŸ”¥ V9 æ ¸å¿ƒé€»è¾‘ï¼šå¼ºåˆ¶åˆ‡ç‰‡ï¼Œæ‹’ç»ä¹±ç 
        const MAX_POINTS = 15;

        const config = {
            "District Pizza Palace": { c: "#ff453a", n: "ç‰¹åŒºæŠ«è¨" },
            "Domino's Pizza":        { c: "#0a84ff", n: "è¾¾ç¾ä¹" },
            "Papa John's Pizza":     { c: "#bf5af2", n: "æ£’çº¦ç¿°" },
            "Wiseguy Pizza":         { c: "#ffd60a", n: "Wiseguy" },
            "We":                    { c: "#30d158", n: "We Pizza" },
            "We, The Pizza":         { c: "#30d158", n: "We Pizza" }
        };

        Papa.parse("pizza_data.csv", {
            download: true, header: true, skipEmptyLines: true,
            complete: res => render(res.data)
        });

        function render(data) {
            const groups = {};
            let maxVal = 0;

            // 1. æ•°æ®æ¸…æ´—
            data.forEach(row => {
                let t = row['Timestamp (ET)'];
                let n = row.Name;
                let p = parseInt(row['Live Popularity'] || 0);
                if(!t || !n) return;

                // ç»Ÿä¸€æ—¶é—´æ ¼å¼ 20:00
                if(t.includes(" ")) t = t.split(" ")[1].substring(0, 5);
                
                if(!groups[t]) groups[t] = {};
                groups[t][n] = p;

                if(p > maxVal) maxVal = p;
            });

            // 2. æ›´æ–° KPI
            document.getElementById('val-max').innerText = maxVal;
            if(maxVal > 50) {
                const el = document.getElementById('val-level');
                el.innerText = "HIGH";
                el.style.color = "var(--danger)";
            }

            // 3. ğŸ”ª åˆ‡ç‰‡é€»è¾‘ (åªå–æœ€å 15 ä¸ªæ—¶é—´ç‚¹)
            const times = Object.keys(groups).sort();
            const slicedTimes = times.slice(-MAX_POINTS);

            // 4. æ„å»º Dataset
            const datasets = Object.keys(config).map(name => {
                // æ£€æŸ¥è¿™å®¶åº—åœ¨æœ€è¿‘15ä¸ªç‚¹é‡Œæœ‰æ²¡æœ‰æ•°æ®
                const points = slicedTimes.map(t => groups[t][name] !== undefined ? groups[t][name] : null);
                
                // å¦‚æœå…¨æ˜¯ nullï¼Œå°±ä¸ç”»è¿™æ¡çº¿
                if(points.every(v => v === null)) return null;

                const style = config[name];
                return {
                    label: style.n,
                    data: points,
                    borderColor: style.c,
                    backgroundColor: style.c,
                    borderWidth: 2,
                    tension: 0.35, // è´å¡å°”æ›²çº¿
                    pointRadius: 0, // é»˜è®¤éšè—ç‚¹ï¼Œçœ‹èµ·æ¥æ›´é«˜çº§
                    pointHoverRadius: 6,
                    pointBackgroundColor: '#fff',
                    spanGaps: true
                };
            }).filter(d => d !== null);

            // 5. æ¸²æŸ“å›¾è¡¨
            const ctx = document.getElementById('mainChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: { labels: slicedTimes, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: { 
                        legend: false, // éšè—é»˜è®¤
                        tooltip: {
                            backgroundColor: 'rgba(20,20,20,0.95)',
                            padding: 12,
                            titleColor: '#888',
                            titleFont: { size: 10 },
                            bodyFont: { size: 13, weight: 'bold' },
                            cornerRadius: 8,
                            displayColors: true
                        }
                    },
                    scales: {
                        x: { 
                            grid: { display: false },
                            ticks: { color: '#555', font: {size: 10}, maxRotation: 0 }
                        },
                        y: { 
                            grid: { color: '#222', borderDash: [6, 6] },
                            ticks: { display: false }, // æç®€é£æ ¼
                            beginAtZero: true
                        }
                    }
                }
            });

            // 6. æ¸²æŸ“åº•éƒ¨èƒ¶å›Šå›¾ä¾‹
            const legBox = document.getElementById('legend-container');
            datasets.forEach(d => {
                legBox.innerHTML += `
                    <div class="pill">
                        <div class="color-block" style="background:${d.borderColor}"></div>
                        ${d.label}
                    </div>
                `;
            });
        }
    </script>
</body>
</html>
