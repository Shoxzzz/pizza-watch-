<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>äº”è§’å¤§æ¥¼æƒ…æŠ¥å±€</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;700;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        :root { 
            --bg: #000000; --card-bg: #121212; --text: #fff; --sub: #666;
            --danger: #ff3b30; --warn: #ffcc00; --safe: #32d74b; --blue: #0a84ff;
        }
        body { background: var(--bg); color: var(--text); font-family: 'Noto Sans SC', sans-serif; margin: 0; padding: 0; padding-bottom: 80px; }
        
        .header { padding: 16px 20px; background: rgba(10,10,10,0.95); position: sticky; top: 0; z-index: 99; border-bottom: 1px solid #222; display: flex; justify-content: space-between; align-items: center; backdrop-filter: blur(20px); }
        .title { font-weight: 900; letter-spacing: 1px; }
        .live-badge { font-size: 11px; font-weight: bold; color: var(--safe); background: rgba(50,215,75,0.1); padding: 4px 8px; border-radius: 4px; display: flex; align-items: center; gap: 6px; }
        .blink { width: 6px; height: 6px; background: currentColor; border-radius: 50%; animation: blink 2s infinite; } @keyframes blink { 0% {opacity:1} 50% {opacity:0.3} }

        .container { padding: 15px; display: flex; flex-direction: column; gap: 15px; }

        /* çŠ¶æ€æ  */
        .status-banner { background: #111; border: 1px solid #333; border-radius: 12px; padding: 20px; position: relative; overflow: hidden; }
        .status-main { font-size: 28px; font-weight: 900; margin: 5px 0; }
        .status-desc { font-size: 12px; color: #aaa; }
        .status-bg-glow { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0.1; pointer-events: none; }
        
        /* ä»ªè¡¨ç›˜ */
        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .dash-card { background: #1a1a1a; border: 1px solid #333; border-radius: 12px; padding: 15px; display: flex; flex-direction: column; justify-content: center; }
        .dash-val { font-size: 26px; font-weight: 900; }
        .dash-lbl { font-size: 11px; color: #888; font-weight: bold; }

        /* åˆ—è¡¨å¡ç‰‡ */
        .card { background: var(--card-bg); border: 1px solid #2a2a2a; border-radius: 12px; padding: 16px; display: flex; flex-direction: column; gap: 12px; position: relative; }
        .card.core { border-color: rgba(255,59,48,0.4); box-shadow: 0 0 15px rgba(255,59,48,0.1) inset; }
        
        .tac-tag { position: absolute; top: 0; right: 0; font-size: 9px; font-weight: 900; padding: 3px 10px; border-bottom-left-radius: 10px; }
        .tag-red { background: rgba(255,59,48,0.2); color: var(--danger); }
        .tag-blue { background: rgba(10,132,255,0.2); color: var(--blue); }
        .tag-yellow { background: rgba(255,204,0,0.2); color: var(--warn); }
        .tag-green { background: rgba(50,215,75,0.2); color: var(--safe); }

        .row-top { display: flex; justify-content: space-between; }
        .shop-name { font-size: 16px; font-weight: 700; color: #fff; }
        .shop-desc { font-size: 11px; color: var(--sub-text); }
        .big-score { font-size: 28px; font-weight: 900; }
        .row-stats { display: flex; gap: 10px; background: #080808; padding: 10px; border-radius: 8px; }
        .stat-box { flex: 1; } .stat-val { font-size: 13px; font-weight: 700; } .stat-lbl { font-size: 10px; color: #555; }
        .spark-bar { flex: 1; background: #333; border-radius: 2px; }

        /* æ–°é—» */
        .news-head { font-size: 12px; font-weight: 900; border-bottom: 1px solid #333; padding-bottom: 5px; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; letter-spacing: 1px; }
        .news-item { background: #0d0d0d; border-left: 3px solid #333; padding: 12px; border-radius: 0 8px 8px 0; margin-bottom: 8px; display: block; text-decoration: none; transition: background 0.2s; }
        .news-item:active { background: #222; }
        .news-meta { font-family: 'JetBrains Mono', monospace; font-size: 10px; color: var(--blue); margin-bottom: 4px; }
        .news-title { color: #ddd; font-size: 13px; font-weight: 500; line-height: 1.4; }

        /* æ‰‹å†Œ & çŸ©é˜µ */
        .manual { background: #090909; border: 1px solid #333; border-radius: 12px; padding: 20px; display: flex; flex-direction: column; gap: 20px; }
        .man-head { font-size: 12px; font-weight: 900; color: #fff; border-bottom: 1px solid #333; padding-bottom: 8px; margin-bottom: 10px; }
        
        .man-row { display: flex; gap: 10px; align-items: flex-start; margin-bottom: 8px; font-size: 11px; color: #888; }
        .man-badge { width: 50px; text-align: center; font-weight: 900; font-size: 9px; padding: 2px 0; border-radius: 4px; border: 1px solid #333; flex-shrink: 0; }
        
        /* çŸ©é˜µå¡ç‰‡ä¼˜åŒ– */
        .matrix-grid { display: grid; grid-template-columns: 1fr; gap: 10px; }
        .matrix-card { 
            background: #151515; border: 1px solid #2a2a2a; border-radius: 8px; padding: 12px;
            display: flex; flex-direction: column; gap: 8px;
        }
        
        .formula-row { display: flex; align-items: center; gap: 6px; font-family: 'JetBrains Mono', monospace; font-size: 10px; font-weight: bold; }
        .f-tag { padding: 2px 6px; border-radius: 4px; border: 1px solid #333; }
        .f-red { background: rgba(255,59,48,0.15); color: var(--danger); border-color: var(--danger); }
        .f-gray { background: #222; color: #666; border-color: #444; }
        .f-green { background: rgba(50,215,75,0.15); color: var(--safe); border-color: var(--safe); }
        .f-plus { color: #555; }
        
        .res-title { font-weight: 900; font-size: 13px; }
        .res-desc { font-size: 10px; color: #666; margin-top: 2px; }
        
        /* åŠ è½½ä¸ç©ºçŠ¶æ€ */
        .loading { text-align: center; margin: 30px; color: #444; font-size: 12px; font-style: italic; }
        .empty-state { text-align: center; padding: 20px; color: #555; font-size: 12px; border: 1px dashed #333; border-radius: 8px; }
    </style>
</head>
<body>
    <div class="header">
        <div class="title">äº”è§’å¤§æ¥¼æƒ…æŠ¥å±€</div>
        <div class="live-badge"><div class="blink"></div>LIVE</div>
    </div>

    <div class="container">
        <div id="status-area">
            <div class="loading">æ­£åœ¨åˆ†ææˆ˜ç•¥æ€åŠ¿...</div>
        </div>
        
        <div id="dash-area"></div>
        
        <div id="list-area">
            <div class="loading">æ­£åœ¨è¿æ¥å«æ˜Ÿæ•°æ®...</div>
        </div>
        
        <div>
            <div class="news-head"><span>ğŸ“°</span> å®æ—¶åŠ å¯†ç”µè®¯ (NEWS WIRE)</div>
            <div id="news-feed">
                <div class="loading">æ­£åœ¨æˆªè·é€šè®¯...</div>
            </div>
        </div>

        <div class="manual">
            <div>
                <div class="man-head">ğŸ“‚ èµ„äº§æ¡£æ¡ˆ (ASSETS)</div>
                <div class="man-row"><div class="man-badge" style="color:#ff3b30; border-color:#ff3b30">CORE</div><div>ç‰¹åŒºæŠ«è¨ã€‚æ ¸å¿ƒæŒ‡æ ‡ï¼Œæœ€æ•æ„Ÿã€‚</div></div>
                <div class="man-row"><div class="man-badge" style="color:#0a84ff; border-color:#0a84ff">SUPPLY</div><div>è¾¾ç¾ä¹/æ£’çº¦ç¿°ã€‚è¡¥ç»™çº¿ï¼Œä»£è¡¨åŠ ç­ã€‚</div></div>
                <div class="man-row"><div class="man-badge" style="color:#ffcc00; border-color:#ffcc00">CROWD</div><div>Wiseguyã€‚å•†åœˆæ•£å®¢ï¼Œä»£è¡¨äººç¾¤ã€‚</div></div>
                <div class="man-row"><div class="man-badge" style="color:#32d74b; border-color:#32d74b">FLANK</div><div>WeæŠ«è¨ã€‚ä¾§ç¿¼å¯¹ç…§ï¼Œç”¨äºå»å™ªã€‚</div></div>
            </div>

            <div>
                <div class="man-head">ğŸ§  è”åˆæƒ…æŠ¥çŸ©é˜µ (ANALYSIS MATRIX)</div>
                <div class="matrix-grid">
                    <div class="matrix-card" style="border-left: 3px solid var(--danger)">
                        <div class="formula-row">
                            <span class="f-tag f-red">SUPPLY é«˜</span> <span class="f-plus">+</span> <span class="f-tag f-gray">CORE ä½</span>
                        </div>
                        <div>
                            <div class="res-title" style="color:var(--danger)">ğŸš¨ å†…éƒ¨å°é” (LOCKDOWN)</div>
                            <div class="res-desc">åªè¿›ä¸å‡º (ç‚¹å¤–å–)ã€‚æœ€å±é™©ä¿¡å·ã€‚</div>
                        </div>
                    </div>

                    <div class="matrix-card" style="border-left: 3px solid var(--danger)">
                        <div class="formula-row">
                            <span class="f-tag f-red">CORE é«˜</span> <span class="f-plus">+</span> <span class="f-tag f-gray">FLANK ä½</span>
                        </div>
                        <div>
                            <div class="res-title" style="color:var(--danger)">ğŸ¯ ç¡®è®¤è¡ŒåŠ¨ (CONFIRMED)</div>
                            <div class="res-desc">ä»…äº”è§’å¤§æ¥¼æ´»è·ƒï¼Œå‘¨è¾¹å†·æ¸…ã€‚çœŸå®æƒ…æŠ¥ã€‚</div>
                        </div>
                    </div>

                    <div class="matrix-card" style="border-left: 3px solid #fff">
                        <div class="formula-row">
                            <span class="f-tag f-red">CORE é«˜</span> <span class="f-plus">+</span> <span class="f-tag f-green">FLANK é«˜</span>
                        </div>
                        <div>
                            <div class="res-title" style="color:#fff">ğŸ‰ è™šå‡è­¦æŠ¥ (FALSE ALARM)</div>
                            <div class="res-desc">å…¨åŒºéƒ½åœ¨è¿‡å‘¨æœ«ï¼Œæ— æˆ˜æœ¯ä»·å€¼ã€‚</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div style="text-align:center; font-size:10px; color:#333;">PENTAGON OPS V35 // DUAL AGENT EDITION</div>
    </div>

    <script>
        // æˆ˜æœ¯å­—å…¸
        const DICT = {
            "District": { name: "ç‰¹åŒºæŠ«è¨", desc: "æ ¸å¿ƒæŒ‡æ ‡ (é¦–é€‰)", tag: "CORE INTEL", cls: "tag-red", core: true },
            "Domino":   { name: "è¾¾ç¾ä¹",   desc: "åå‹¤è¡¥ç»™ (ä¸»)", tag: "SUPPLY LINE", cls: "tag-blue", core: false },
            "Papa":     { name: "æ£’çº¦ç¿°",   desc: "åå‹¤è¡¥ç»™ (å¤‡)", tag: "SUPPLY LINE", cls: "tag-blue", core: false },
            "Wiseguy":  { name: "Wiseguy",  desc: "äººå‘˜èšé›† (æ•£)", tag: "CROWD INTEL", cls: "tag-yellow", core: false },
            "We":       { name: "WeæŠ«è¨",   desc: "ä¾§ç¿¼è§‚å¯Ÿ (è¾…)", tag: "FLANK WATCH", cls: "tag-green", core: false }
        };

        // ç‹¬ç«‹é€šé“ï¼šæŠ«è¨æ•°æ®
        Papa.parse("pizza_data.csv", {
            download: true, header: true, skipEmptyLines: true,
            complete: function(res) { renderPizza(res.data); },
            error: function() { 
                document.getElementById('list-area').innerHTML = '<div class="empty-state">æŠ«è¨ç‰¹å·¥ç¦»çº¿</div>';
                document.getElementById('status-area').innerHTML = '<div class="status-banner" style="border-color:#333"><div class="status-main" style="color:#666">OFFLINE</div><div class="status-desc">æ— æ³•è¿æ¥æŠ«è¨æ•°æ®æº</div></div>';
            }
        });

        // ç‹¬ç«‹é€šé“ï¼šæ–°é—»æ•°æ®
        Papa.parse("pentagon_news.csv", {
            download: true, header: true, skipEmptyLines: true,
            complete: function(res) { renderNews(res.data); },
            error: function() { 
                document.getElementById('news-feed').innerHTML = '<div class="empty-state">æ–°é—»ä¿¡é“é™é»˜</div>'; 
            }
        });

        function renderNews(data) {
            const el = document.getElementById('news-feed');
            if(!data || !data.length) {
                el.innerHTML = '<div class="empty-state">æš‚æ— æˆªè·çš„é€šè®¯</div>';
                return;
            }
            el.innerHTML = "";
            // å–å‰ 5 æ¡
            data.slice(0, 5).forEach(r => {
                const time = r.Time || "--:--";
                const src = r.Source || "Unknown";
                const title = r.Title || "No Title";
                const link = r.Link || "#";

                el.innerHTML += `
                <a href="${link}" target="_blank" class="news-item">
                    <div class="news-meta"><span>${time}</span> // ${src}</div>
                    <div class="news-title">${title}</div>
                </a>`;
            });
        }

        function renderPizza(data) {
            if(!data || !data.length) return;

            // 1. æ•°æ®æ¸…æ´—ä¸åˆ†ç»„
            const groups = {};
            data.forEach(r => {
                let k = null; const n = r.Name||"";
                if(n.includes("District")) k="District"; else if(n.includes("Domino")) k="Domino";
                else if(n.includes("Papa")) k="Papa"; else if(n.includes("Wiseguy")) k="Wiseguy";
                else if(n.includes("We")) k="We";

                if(k) {
                    if(!groups[k]) groups[k] = [];
                    // å®¹é”™å¤„ç†ï¼šç¡®ä¿æ˜¯æ•°å­—
                    groups[k].push({
                        p: parseInt(r['Live Popularity']||0), 
                        t: r['Timestamp (ET)'] || "00:00"
                    });
                }
            });

            // 2. è®¡ç®—æˆ˜æœ¯æŒ‡æ ‡
            let total=0, diffTotal=0, corePop=0;
            const list = [];
            
            Object.keys(groups).forEach(k => {
                const hist = groups[k];
                const curr = hist[hist.length-1];
                if(k==="District") corePop = curr.p;

                let d = 0; 
                if(hist.length>=2) d = curr.p - hist[hist.length-2].p;
                
                total += curr.p; 
                diffTotal += d;
                
                list.push({key:k, hist:hist, curr:curr, diff:d});
            });

            // 3. æ’åºï¼šCoreç½®é¡¶ï¼Œå…¶ä»–æŒ‰çƒ­åº¦é™åº
            list.sort((a,b) => {
                const coreA = DICT[a.key].core;
                const coreB = DICT[b.key].core;
                if(coreA === coreB) return b.curr.p - a.curr.p;
                return coreA ? -1 : 1;
            });

            // 4. æ¸²æŸ“çŠ¶æ€æ  (Threat Level)
            let sTxt="å¹³é™ (NORMAL)", sDesc="äº”è§’å¤§æ¥¼å‘¨è¾¹æ´»åŠ¨æ°´å¹³æ­£å¸¸ã€‚", sCol="var(--safe)", sGlow="rgba(50,215,75,0.1)";
            if(total > 150 || corePop > 80) { 
                sTxt="ç´§æ€¥ (CRITICAL)"; sDesc="ğŸš¨ è­¦å‘Šï¼šæ£€æµ‹åˆ°ä¸¥é‡äººå‘˜æ´»åŠ¨ï¼Œå»ºè®®ç ”åˆ¤ã€‚"; sCol="var(--danger)"; sGlow="rgba(255,59,48,0.2)"; 
            } else if(total > 100 || corePop > 50) { 
                sTxt="æ´»è·ƒ (ELEVATED)"; sDesc="âš ï¸ æ³¨æ„ï¼šæ´»åŠ¨æ°´å¹³æ˜æ˜¾é«˜äºå¹³æ—¶ã€‚"; sCol="var(--warn)"; sGlow="rgba(255,204,0,0.15)"; 
            }
            
            document.getElementById('status-area').innerHTML = `
                <div class="status-banner" style="border-color:${sCol}">
                    <div class="status-bg-glow" style="background:${sCol}; opacity:0.05"></div>
                    <div class="status-label" style="color:${sCol}">å½“å‰å¨èƒç­‰çº§</div>
                    <div class="status-main" style="color:${sCol}">${sTxt}</div>
                    <div class="status-desc">${sDesc}</div>
                </div>
            `;

            // 5. æ¸²æŸ“ä»ªè¡¨ç›˜
            let dCol = diffTotal>0 ? "var(--danger)" : (diffTotal<0?"var(--safe)":"#888");
            let dSym = diffTotal>0 ? "+" : "";
            
            document.getElementById('dash-area').innerHTML = `
                <div class="dashboard-grid">
                    <div class="dash-card">
                        <div class="dash-lbl">å®æ—¶æ€»çƒ­åº¦</div>
                        <div class="dash-val" style="color:${total>150?'var(--danger)':'#fff'}">${total}</div>
                    </div>
                    <div class="dash-card">
                        <div class="dash-lbl">1H å˜åŒ–é‡</div>
                        <div class="dash-val" style="color:${dCol}">${dSym}${diffTotal}</div>
                    </div>
                </div>
            `;

            // 6. æ¸²æŸ“æŠ«è¨åˆ—è¡¨
            const el = document.getElementById('list-area'); 
            el.innerHTML="";
            
            list.forEach(i => {
                const conf = DICT[i.key];
                const dfCol = i.diff>0 ? "var(--danger)" : (i.diff<0 ? "var(--safe)" : "#666");
                const dfSym = i.diff>0 ? "â–² +" : (i.diff<0 ? "â–¼ " : "");
                const timeStr = i.curr.t.includes(" ") ? i.curr.t.split(" ")[1].substring(0,5) : i.curr.t;

                // ç”Ÿæˆè¿·ä½ èµ°åŠ¿å›¾
                let bars = ""; 
                const spark = i.hist.slice(-20); // å–æœ€è¿‘20ä¸ªç‚¹
                spark.forEach((d,idx) => {
                    const isLast = idx === spark.length-1;
                    const h = Math.max(5, d.p); // æœ€å°é«˜åº¦5%
                    const bg = isLast ? '#fff' : (d.p>50 ? '#ff3b30' : '#333');
                    const op = isLast ? 1 : 0.6;
                    bars += `<div class="spark-bar" style="height:${h}%; background:${bg}; opacity:${op}"></div>`;
                });

                el.innerHTML += `
                <div class="card ${conf.core?'core':''}">
                    <div class="tac-tag ${conf.cls}">${conf.tag}</div>
                    <div class="row-top">
                        <div>
                            <div class="shop-name">${conf.name}</div>
                            <div class="shop-desc">${conf.desc}</div>
                        </div>
                        <div class="big-score" style="color:${i.curr.p>50?'#ff3b30':'#fff'}">${i.curr.p}</div>
                    </div>
                    
                    <div class="row-stats">
                        <div class="stat-box">
                            <div class="stat-lbl">1H å˜åŒ–</div>
                            <div class="stat-val" style="color:${dfCol}">${dfSym}${i.diff}</div>
                        </div>
                        <div class="stat-box" style="padding-left:10px; border-left:1px solid #222">
                            <div class="stat-lbl">æ›´æ–°äº</div>
                            <div class="stat-val" style="color:#888">${timeStr}</div>
                        </div>
                    </div>
                    
                    <div class="spark-container" style="height:24px; margin-top:8px">${bars}</div>
                </div>`;
            });
        }
    </script>
</body>
</html>
