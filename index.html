<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>PENTAGON OPS FINAL</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        :root { --bg: #000; --card: #121212; --text: #fff; --sub: #888; --danger: #ff453a; --success: #30d158; }
        body { background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom); }
        .header { padding: 12px 20px; display: flex; justify-content: space-between; border-bottom: 1px solid #222; }
        .brand { font-weight: 700; font-size: 16px; }
        .live { color: var(--success); font-size: 12px; font-weight: bold; display: flex; align-items: center; gap: 5px; }
        .dot { width: 6px; height: 6px; background: var(--success); border-radius: 50%; animation: p 1s infinite; } @keyframes p { 50% { opacity: 0.3; } }
        
        .kpi-scroll { display: flex; gap: 10px; padding: 15px 20px; overflow-x: auto; flex-shrink: 0; }
        .card { background: var(--card); border: 1px solid #333; border-radius: 10px; padding: 10px 15px; min-width: 100px; }
        .lbl { font-size: 10px; color: var(--sub); text-transform: uppercase; margin-bottom: 5px; }
        .val { font-size: 22px; font-weight: 700; }

        .chart-wrap { flex: 1; margin: 0 10px; background: #080808; border-radius: 15px; position: relative; }
        .leg-bar { padding: 15px 20px; display: flex; gap: 8px; overflow-x: auto; border-top: 1px solid #222; flex-shrink: 0; }
        .pill { background: #1a1a1a; padding: 5px 10px; border-radius: 6px; font-size: 11px; color: #ccc; white-space: nowrap; border-left: 3px solid transparent; }
    </style>
</head>
<body>
    <div class="header">
        <div class="brand">PENTAGON V10</div>
        <div class="live"><div class="dot"></div>SYNCED</div>
    </div>

    <div class="kpi-scroll">
        <div class="card"><div class="lbl">Max Peak</div><div class="val" id="v-max">--</div></div>
        <div class="card"><div class="lbl">Status</div><div class="val" id="v-stat" style="color:var(--success)">LOW</div></div>
        <div class="card"><div class="lbl">Points</div><div class="val" id="v-pts">0</div></div>
    </div>

    <div class="chart-wrap"><canvas id="C"></canvas></div>
    <div class="leg-bar" id="Leg"></div>

    <script>
        // âš¡ï¸ è¿™é‡Œæ˜¯ä¸­æ–‡æ˜¾ç¤ºçš„å‘½æ ¹å­ï¼å¿…é¡»å’ŒPythonçš„ Key å®Œå…¨ä¸€è‡´
        const CFG = {
            "District": { c: "#ff453a", n: "ç‰¹åŒºæŠ«è¨" },
            "Dominos":  { c: "#0a84ff", n: "è¾¾ç¾Žä¹" },
            "Papa":     { c: "#bf5af2", n: "æ£’çº¦ç¿°" },
            "Wiseguy":  { c: "#ffd60a", n: "Wiseguy" },
            "WePizza":  { c: "#30d158", n: "We Pizza" }
        };

        Papa.parse("pizza_data.csv", {
            download: true, header: true, skipEmptyLines: true,
            complete: res => render(res.data)
        });

        function render(data) {
            const grps = {}; let max = 0;
            
            data.forEach(r => {
                let t = r['Timestamp (ET)'];
                let n = r.Name; 
                let p = parseInt(r['Live Popularity']||0);
                
                // ðŸš‘ å…¼å®¹æ€§è¡¥ä¸ï¼šå¦‚æžœCSVé‡Œæ˜¯æ—§çš„é•¿åå­—ï¼Œå¼ºè¡Œè½¬æ¢æˆæ–°çš„çŸ­ä»£ç 
                // è¿™æ ·ä½ çš„æ—§æ•°æ®ä¹Ÿèƒ½æ˜¾ç¤ºä¸­æ–‡äº†ï¼
                if(n.includes("District")) n = "District";
                else if(n.includes("Domino")) n = "Dominos";
                else if(n.includes("Papa")) n = "Papa";
                else if(n.includes("We")) n = "WePizza";
                else if(n.includes("Wiseguy")) n = "Wiseguy";

                if(!t || !CFG[n]) return; 

                // æ—¶é—´æˆªå–
                if(t.includes(" ")) t = t.split(" ")[1].substring(0, 5);
                
                if(!grps[t]) grps[t] = {};
                grps[t][n] = p;
                if(p > max) max = p;
            });

            document.getElementById('v-max').innerText = max;
            if(max > 50) {
                const s = document.getElementById('v-stat');
                s.innerText = "HIGH"; s.style.color = "var(--danger)";
            }

            // åªæ˜¾ç¤ºæœ€è¿‘ 15 ä¸ªç‚¹
            const times = Object.keys(grps).sort().slice(-15);
            document.getElementById('v-pts').innerText = times.length;

            const dsets = Object.keys(CFG).map(k => {
                const pts = times.map(t => grps[t][k] ?? null);
                // åªæœ‰å…¨ç©ºæ‰éšè—ï¼Œåªè¦æœ‰ç‚¹å°±æ˜¾ç¤º
                if(pts.every(x => x === null)) return null;
                return {
                    label: CFG[k].n, // è¿™é‡Œå–å‡ºæ¥çš„å°±æ˜¯ä¸­æ–‡åï¼
                    data: pts,
                    borderColor: CFG[k].c, backgroundColor: CFG[k].c,
                    borderWidth: 2, tension: 0.3, pointRadius: 2, 
                    spanGaps: true // å…³é”®ï¼šå…è®¸æ–­ç‚¹ç»­è¿ž
                };
            }).filter(x => x);

            new Chart(document.getElementById('C'), {
                type: 'line',
                data: { labels: times, datasets: dsets },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: { legend: false },
                    scales: { x: { grid: {display:false}, ticks:{color:'#666', font:{size:10}} }, y: { display:false, beginAtZero:true } }
                }
            });

            const lb = document.getElementById('Leg');
            dsets.forEach(d => {
                lb.innerHTML += `<div class="pill" style="border-color:${d.borderColor}">${d.label}</div>`;
            });
        }
    </script>
</body>
</html>
