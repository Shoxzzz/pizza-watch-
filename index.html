<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PENTAGON OPS V8</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        :root {
            --bg: #050505;
            --card: #151515;
            --text: #eaeaea;
            --accent: #2563eb; /* ç§‘æŠ€è“ */
            --danger: #ef4444;
            --success: #22c55e;
        }
        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Inter', sans-serif;
            margin: 0; padding: 0;
            height: 100vh;
            display: flex; flex-direction: column;
            overflow: hidden; /* ç¦æ­¢é¡µé¢æ»šåŠ¨ */
        }

        /* é¡¶éƒ¨æ  */
        .header {
            padding: 15px 20px;
            background: var(--card);
            border-bottom: 1px solid #333;
            display: flex; justify-content: space-between; align-items: center;
        }
        .title { font-weight: 600; font-size: 14px; letter-spacing: 1px; color: #fff; }
        .live-status { 
            font-size: 10px; color: var(--success); 
            display: flex; align-items: center; gap: 6px;
            background: rgba(34, 197, 94, 0.1); padding: 4px 8px; border-radius: 4px;
        }
        .dot { width: 6px; height: 6px; background: var(--success); border-radius: 50%; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }

        /* KPI æ•°æ®æ¿ - æ”¾åœ¨å›¾è¡¨ä¸Šæ–¹ */
        .kpi-board {
            display: grid; grid-template-columns: 1fr 1fr; gap: 15px;
            padding: 20px 20px 10px 20px;
        }
        .kpi-item {
            background: var(--card); border: 1px solid #333; border-radius: 8px;
            padding: 12px;
        }
        .kpi-label { font-size: 10px; color: #888; text-transform: uppercase; margin-bottom: 5px; }
        .kpi-val { font-size: 20px; font-weight: 600; color: #fff; }

        /* å›¾è¡¨å®¹å™¨ - è‡ªåŠ¨æ’‘æ»¡å‰©ä½™ç©ºé—´ */
        .chart-wrapper {
            flex: 1; 
            position: relative; 
            margin: 10px 20px;
            min-height: 0; /* å…³é”®ï¼šé˜²æ­¢æº¢å‡º */
        }

        /* åº•éƒ¨æç®€å›¾ä¾‹ */
        .legend {
            padding: 10px 20px 30px 20px;
            display: flex; gap: 10px; overflow-x: auto;
            border-top: 1px solid #222;
        }
        .pill {
            background: #222; padding: 6px 10px; border-radius: 4px;
            font-size: 11px; color: #ccc; white-space: nowrap;
            display: flex; align-items: center; gap: 6px;
            border-left: 3px solid transparent; /* è‰²æ¡åœ¨å·¦è¾¹ */
        }

    </style>
</head>
<body>

    <div class="header">
        <div class="title">PENTAGON V8</div>
        <div class="live-status"><div class="dot"></div>MONITORING</div>
    </div>

    <div class="kpi-board">
        <div class="kpi-item">
            <div class="kpi-label">Max Spike (æœ€é«˜çƒ­åº¦)</div>
            <div class="kpi-val" id="max-val">--</div>
        </div>
        <div class="kpi-item">
            <div class="kpi-label">Threat Level (è­¦æˆ’)</div>
            <div class="kpi-val" id="level-val" style="color:var(--success)">LOW</div>
        </div>
    </div>

    <div class="chart-wrapper">
        <canvas id="mainChart"></canvas>
    </div>

    <div class="legend" id="legend-box"></div>

    <script>
        // ğŸ”¥ V8 æ ¸å¿ƒé€»è¾‘ï¼šåªæ˜¾ç¤ºæœ€è¿‘çš„ 15 ä¸ªç‚¹
        // å“ªæ€•ä½ æœ‰ 10000 æ¡æ•°æ®ï¼Œä¹Ÿåªè£åˆ‡æœ€å 15 æ¡ç»™å›¾è¡¨
        // è¿™å°±æ˜¯è§£å†³â€œä¹±æˆä¸€å›¢â€çš„å”¯ä¸€è§£æ³•
        const SHOW_LIMIT = 15;

        const colors = {
            "District Pizza Palace": "#ef4444", // çº¢
            "Domino's Pizza": "#3b82f6",       // è“
            "Papa John's Pizza": "#a855f7",    // ç´«
            "Wiseguy Pizza": "#eab308",        // é»„
            "We": "#22c55e",                   // ç»¿
            "We, The Pizza": "#22c55e"
        };
        const names = {
            "District Pizza Palace": "ç‰¹åŒºæŠ«è¨", "Domino's Pizza": "è¾¾ç¾ä¹",
            "Papa John's Pizza": "æ£’çº¦ç¿°", "Wiseguy Pizza": "Wiseguy",
            "We": "We Pizza", "We, The Pizza": "We Pizza"
        };

        Papa.parse("pizza_data.csv", {
            download: true, header: true, skipEmptyLines: true,
            complete: res => render(res.data)
        });

        function render(data) {
            // 1. æ•°æ®æ•´ç†
            const group = {};
            let maxScore = 0;

            data.forEach(d => {
                const t = d['Timestamp (ET)'];
                const n = d.Name;
                const p = parseInt(d['Live Popularity'] || 0);
                if(!t || !n) return;

                // ç®€åŒ–æ—¶é—´ï¼šåªå– 10:30 è¿™ç§æ ¼å¼
                const timeStr = t.includes(" ") ? t.split(" ")[1].substring(0, 5) : t;
                
                if(!group[timeStr]) group[timeStr] = {};
                group[timeStr][n] = p;

                if(p > maxScore) maxScore = p;
            });

            // 2. æ›´æ–° KPI
            document.getElementById('max-val').innerText = maxScore;
            if(maxScore > 50) {
                const lv = document.getElementById('level-val');
                lv.innerText = "HIGH";
                lv.style.color = "var(--danger)";
            }

            // 3. ğŸ”ª æ ¸å¿ƒåˆ‡å‰²ï¼šåªå–æœ€å 15 ä¸ªæ—¶é—´æ®µ
            const allTimes = Object.keys(group).sort();
            const slicedTimes = allTimes.slice(-SHOW_LIMIT); // è´Ÿæ•°ä»£è¡¨ä»åå¾€å‰å–

            // 4. æ„å»ºæ•°æ®é›†
            const datasets = Object.keys(colors).map(shop => {
                const points = slicedTimes.map(time => {
                    return group[time][shop] !== undefined ? group[time][shop] : null;
                });
                
                // å…¨ç©ºçš„æ•°æ®ä¸æ˜¾ç¤º
                if(points.every(x => x === null)) return null;

                return {
                    label: names[shop] || shop,
                    data: points,
                    borderColor: colors[shop],
                    backgroundColor: colors[shop],
                    borderWidth: 2,
                    pointRadius: 3, // ç‚¹çš„å¤§å°
                    pointBackgroundColor: '#000',
                    tension: 0.3, // æ›²çº¿å¹³æ»‘åº¦
                    spanGaps: true // æ–­ç‚¹ç»­è¿
                };
            }).filter(d => d);

            // 5. ç»˜å›¾
            new Chart(document.getElementById('mainChart'), {
                type: 'line',
                data: { labels: slicedTimes, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: { legend: false }, // éšè—è‡ªå¸¦å›¾ä¾‹
                    scales: {
                        x: { grid: { display: false }, ticks: { color: '#666', font: {size: 10} } },
                        y: { 
                            grid: { color: '#222', borderDash: [5,5] }, 
                            ticks: { display: false }, // éšè—Yè½´æ•°å­—
                            beginAtZero: true, suggestedMax: 100 
                        }
                    }
                }
            });

            // 6. ç”Ÿæˆåº•éƒ¨å›¾ä¾‹
            const leg = document.getElementById('legend-box');
            datasets.forEach(d => {
                leg.innerHTML += `<div class="pill" style="border-left-color:${d.borderColor}">${d.label}</div>`;
            });
        }
    </script>
</body>
</html>
